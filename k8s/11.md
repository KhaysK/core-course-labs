# Lab 11: Kubernetes Secrets and Hashicorp Vault

## Using kubectl

### I created secret with command `kubectl create secret`

```bash
kubectl create secret generic pswd-khays --from-literal=passwd=1234khays1234
secret/pswd-khays created

kubectl get secrets pswd-khays
NAME         TYPE     DATA   AGE
pswd-khays   Opaque   1      21s
```

### To decode we can use `kubectl get secret`

```bash
kubectl get secret pswd-khays -o jsonpath="{.data.passwd}" | base64 -d
1234khays1234
```

## Using Helm

### Generate GPG Key

```bash
gpg --gen-key

pub   rsa3072 2023-11-19 [SC] [expires: 2025-11-18]
      EC2C55704EED7BBD51A238ECAA6773C4137A266B
uid                      khabib khays <haysadykov@gmail.com>
sub   rsa3072 2023-11-19 [E] [expires: 2025-11-18]
```

### Encrypt Secrets with SOPS

`sops -p EC2C55704EED7BBD51A238ECAA6773C4137A266B secrets.yaml`

### Helm Secrets Installation

`helm secrets install khays-app ./khays-app -n default -f ./secrets.yaml`

### Lets look what we got with `kubectl get po`

``` bash
kubectl get po
NAME                                READY   STATUS      RESTARTS      AGE
khays-app-66898895d4-59vr2          1/1     Running     0             8m29s
```

### Lets decrypt our secret password

``` bash
kubectl exec khays-app-66898895d4-59vr2 -- printenv | grep MY_PASSWORD
MY_PASSWORD=1234khays1234
```

## Using Vault

### Vault configuration

``` bash
kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/

/ $ vault kv put internal/server/config password="1234khays1234"
======= Secret Path =======
internal/data/server/config

======= Metadata =======
Key                Value
---                -----
created_time       2023-11-19T20:31:49.17524505Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/server/config
======= Secret Path =======
internal/data/server/config

======= Metadata =======
Key                Value
---                -----
created_time       2023-11-19T20:31:49.17524505Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    1234khays1234

/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/

/ $ vault write auth/kubernetes/config kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config

/ $ vault policy write internal-app - <<EOF
> path "internal/data/server/config" {
>         capabilities = ["read"]
> }
> EOF

Success! Uploaded policy: internal-app
/ $ vault write auth/kubernetes/role/internal-app \
>     bound_service_account_names=internal-app \
>     bound_service_account_namespaces=default \
>     policies=internal-app \
>     ttl=24h
Success! Data written to: auth/kubernetes/role/internal-app

```

### Verifications

``` bash
kubectl get po
NAME                                    READY   STATUS      RESTARTS      AGE
khays-app-vault-748d9c9c97-lxrzh        2/2     Running     0             115s
khays-app-vault-748d9c9c97-3xs24        2/2     Running     0             115s
khays-app-vault-748d9c9c97-x7z8c        2/2     Running     0             115s
vault-0                                 1/1     Running     0             32m
vault-agent-injector-576cc6ffc4-zbbn4   1/1     Running     0             32m
```

```bash
cat /vault/secrets/config.txt
data: map[password:1234khays1234]
metadata: map[created_time:2023-11-19T20:31:49.17524505Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
```

```bash
df -h

Filesystem      Size  Used Avail Use% Mounted on
overlay          78G   17G   58G  23% /
tmpfs            64M     0   64M   0% /dev
/dev/nvme0n1p1  938G  225G  666G  26% /etc/hosts
tmpfs            31G  4.0K   31G   1% /vault/secrets
shm              64M     0   64M   0% /dev/shm
tmpfs            31G   12K   31G   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs            16G     0   16G   0% /proc/asound
tmpfs            16G     0   16G   0% /proc/acpi
tmpfs            16G     0   16G   0% /proc/scsi
tmpfs            16G     0   16G   0% /sys/firmware
```
